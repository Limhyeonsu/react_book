# 18. 리덕스 미들웨어를 통한 비동기 작업 관리
리액트 웹 애플리케이션에서 API서버를 연동할 때 API 요청에 대한 상태 관리를 해야한다. 요청 시작시 로딩중임을 요청 성공, 실패시 로딩이 끝났음을 응답에 대한 상태, 실패시 에러에 대한 상태 등을 관리해야 한다.

## 18.1 작업 환경 준비
`yarn add redux react-redux redux-actions` 필요한 라이브러리 다운로드
```javascript
// src/modules/counter.js
import {createAction, handleActions, hanldleActions} from 'redux-actions';

const INCREASE = 'counter/INCREASE';
const DECREASE = 'counter/DECREASE';

export const increase = createAction(INCREASE);
export const decrease = createAction(DECREASE);

const initialState = 0;

const counter = handleActions(
  {
    [INCREASE]: (state) => state + 1,
    [DECREASE]: (state) => state - 1
  },
  initialState
);

export default counter;
```
```javascript
// src/modules/index.js
import {combineReducers} from 'redux';
import counter from './counter';

const rootReducer = combineReducers({
  counter
});

export default rootReducer;
```
```javascript
// src/index.js
import ReactDOM from 'react-dom';
import './index.css';
import App from './App';
import {createStore} from 'redux';
import rootReducer from './modules';
import {Provider} from 'react-redux';

const store = createStore(rootReducer);

ReactDOM.render(
  <Provider store={store}>
    <App />
  </Provider>,
  document.getElementById('root')
);
```
```javascript
// src/components/Counter.js
const Counter = ({onIncrease, onDecrease, number}) => {
  return (
    <div>
      <h1>{number}</h1>
      <button onClick={onIncrease}>+1</button>
      <button onClick={onDecrease}>-1</button>
    </div>
  );
};

export default Counter;
```
```javascript
// src/containers/CounterContainer.js
import Counter from '../components/Counter';
import {connect} from 'react-redux';
import {increase, decrease} from '../modules/counter';

const CounterContainer = ({number, increase, decrease}) => {
  return <Counter number={number} onIncrease={increase} onDecrease={decrease} />;
};

export default connect(
  (state) => ({
    number: state.counter
  }),
  {
    increase,
    decrease
  }
)(CounterContainer);
```
```javascript
// src/App.js
import CounterContainer from './containers/CounterContainer';

const App = () => {
  return (
    <div>
      <CounterContainer />
    </div>
  );
};
export default App;
```

## 18.2 미들웨어란?
리덕스 미들웨어는 액션을 디스패치했을 때 이를 처리하기 앞서 사전에 지정된 작업을 실행한다. 예) 전달받은 액션을 콘솔에 기록, 액션정보를 기반으로 액션 취소, 다른종류의 액션을 추가로 디스패치등..

```javascript
const loggerMiddleware = (store) => (next) => (action) => {
  //미들웨어 기본 구조
};
export default loggerMiddleware;
```
미들웨어는 함수를 반환하는 함수를 반환하는 함수이다.
* store : 리덕스 스토어 인스턴스
* action : 디스패치된 액션
* next : 함수 형태로 store.dispatch와 비슷한 역할을 함, next(action)을 호출하면 그다음 처리해야 할 미들웨어에게 액션을 넘겨주고, 미들웨어가 없다면 리듀서에게 액션을 넘겨준다.

<img src="https://i.imgur.com/fZs5yvY.png" width='500px'>

미들웨어 내부에서 store.dispatch를 사용하면 첫 번째 미들웨어부터 다시 처리, 미들웨어에서 next를 사용하지 않으면 액션이 리듀서에 전달되지 않는다.

```javascript
const loggerMiddleware = (store) => (next) => (action) => {
  console.group(action && action.type); //액션 타입으로 log 그룹화
  console.log('이전상태', store.getState());
  console.log('액션', action);
  next(action); //다음 미들웨어 or 리듀서에게 전달
  console.log('다음 상태', store.getState()); //업데이트된 상태
  console.groupEnd(); //그룹 끝
};

export default loggerMiddleware;


// src/index.js
const store = createStore(rootReducer, applyMiddleware(loggerMiddleware));
```
<img src="../정리/img/redux%20middleware1.PNG" width='500px'>

### redux-logger 사용하기
redux-logger 미들웨어는 위 예제보다 잘 만들어진 라이브러리이다. `yarn add redux-logger` 
```javascript
// src/index.js
const logger = createLogger();
const store = createStore(rootReducer, applyMiddleware(logger));
```
<img src="../정리/img/redux%20middleware2.PNG" width='500px'>